generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CUSTOMER   // Заказчик
  DEVELOPER  // Разработчик (менеджер)
  ADMIN      // Администратор
}

enum ClientType {
  INDIVIDUAL      // Физическое лицо
  LEGAL_ENTITY    // Юридическое лицо
  ENTREPRENEUR    // ИП
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  role      UserRole @default(CUSTOMER)
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isActive  Boolean  @default(true)

  // Новые поля для профиля
  phone          String?
  avatar         String?      // URL аватара

  // Реквизиты клиента
  clientType     ClientType?  // Тип клиента (физ/юр/ИП)
  inn            String?      // ИНН (для ЮЛ и ИП)
  bik            String?      // БИК банка
  accountNumber  String?      // Номер счета

  // Для физ. лиц
  fullName       String?      // Полное ФИО

  // Для юр. лиц и ИП
  companyName    String?      // Название компании
  kpp            String?      // КПП
  ogrn           String?      // ОГРН
  legalAddress   String?      // Юридический адрес
  bankName       String?      // Название банка
  corrAccount    String?      // Корр. счет банка

  // Связь с кодами авторизации
  authCodes AuthCode[]

  // Связь с сессиями
  sessions  Session[]

  // Связь с проектами (как клиент)
  projects  Project[]

  // Связь с задачами (как исполнитель)
  assignedTasks Task[] @relation("AssignedTasks")

  // Связь с уведомлениями
  notifications Notification[]

  // Связь с активностями
  activities    Activity[]

  // Связь с файлами
  files         File[]

  // Связь с настройками
  settings      UserSettings?

  @@index([email])
  @@map("users")
}

model AuthCode {
  id        String   @id @default(uuid())
  code      String   // 6-значный код
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime // Код действителен 10 минут
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  ipAddress String?
  userAgent String?

  @@index([userId])
  @@index([code, used, expiresAt])
  @@map("auth_codes")
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique // JWT токен
  expiresAt DateTime // Сессия на 30 дней
  createdAt DateTime @default(now())
  ipAddress String?
  userAgent String?

  @@index([userId])
  @@index([token])
  @@map("sessions")
}

enum ProjectStatus {
  PLANNING      // Планирование
  IN_PROGRESS   // В работе
  ON_HOLD       // Приостановлен
  COMPLETED     // Завершен
  CANCELLED     // Отменен
}

enum TaskStatus {
  TODO          // К выполнению
  IN_PROGRESS   // В работе
  REVIEW        // На проверке
  DONE          // Выполнено
  CANCELLED     // Отменено
}

enum TaskPriority {
  LOW           // Низкий
  MEDIUM        // Средний
  HIGH          // Высокий
  URGENT        // Срочный
}

model Project {
  id          String        @id @default(uuid())
  name        String
  description String?       @db.Text
  status      ProjectStatus @default(PLANNING)

  // Клиент проекта
  customerId  String
  customer    User          @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Даты
  startDate   DateTime?
  dueDate     DateTime?
  completedAt DateTime?

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Связь с задачами
  tasks       Task[]

  // Связь с активностями
  activities  Activity[]

  // Связь с файлами
  files       File[]

  @@index([customerId])
  @@index([status])
  @@map("projects")
}

model Task {
  id          String       @id @default(uuid())
  title       String
  description String?      @db.Text
  status      TaskStatus   @default(TODO)
  priority    TaskPriority @default(MEDIUM)

  // Проект
  projectId   String
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Исполнитель (опционально)
  assigneeId  String?
  assignee    User?        @relation("AssignedTasks", fields: [assigneeId], references: [id], onDelete: SetNull)

  // Учет времени (в часах)
  timeSpent   Float?       @default(0)

  // Дата, когда была выполнена работа
  workDate    DateTime?

  // Даты
  dueDate     DateTime?
  completedAt DateTime?

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Связь с активностями
  activities  Activity[]

  // Связь с файлами
  files       File[]

  @@index([projectId])
  @@index([assigneeId])
  @@index([status])
  @@map("tasks")
}

enum ContactStatus {
  NEW           // Новая заявка
  IN_PROGRESS   // В обработке
  COMPLETED     // Обработана
  REJECTED      // Отклонена
}

model ContactForm {
  id          String        @id @default(uuid())
  name        String
  email       String
  phone       String?
  project     String        @db.Text // Описание проекта
  status      ContactStatus @default(NEW)

  // Мета информация
  ipAddress   String?
  userAgent   String?

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([status])
  @@index([createdAt])
  @@map("contact_forms")
}

// ============================================
// НОВЫЕ МОДЕЛИ ДЛЯ ЛИЧНОГО КАБИНЕТА
// ============================================

enum NotificationType {
  TASK_ASSIGNED       // Назначена новая задача
  TASK_UPDATED        // Задача обновлена
  TASK_COMPLETED      // Задача завершена
  PROJECT_CREATED     // Создан новый проект
  PROJECT_UPDATED     // Проект обновлен
  PROJECT_COMPLETED   // Проект завершен
  DEADLINE_APPROACHING // Приближается дедлайн
  COMMENT_ADDED       // Добавлен комментарий
  FILE_UPLOADED       // Загружен файл
  SYSTEM              // Системное уведомление
}

model Notification {
  id        String           @id @default(uuid())
  type      NotificationType
  title     String
  message   String           @db.Text
  read      Boolean          @default(false)

  // Получатель
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Связанные объекты (опционально)
  projectId String?
  taskId    String?

  // Ссылка для перехода
  link      String?

  createdAt DateTime         @default(now())

  @@index([userId, read])
  @@index([createdAt])
  @@map("notifications")
}

enum ActivityType {
  PROJECT_CREATED       // Проект создан
  PROJECT_UPDATED       // Проект обновлен
  PROJECT_STATUS_CHANGED // Статус проекта изменен
  TASK_CREATED          // Задача создана
  TASK_UPDATED          // Задача обновлена
  TASK_STATUS_CHANGED   // Статус задачи изменен
  TASK_ASSIGNED         // Задача назначена
  FILE_UPLOADED         // Файл загружен
  COMMENT_ADDED         // Комментарий добавлен
  USER_JOINED           // Пользователь присоединился
}

model Activity {
  id          String       @id @default(uuid())
  type        ActivityType
  description String       @db.Text

  // Кто совершил действие
  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Связанные объекты (опционально)
  projectId   String?
  project     Project?     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  taskId      String?
  task        Task?        @relation(fields: [taskId], references: [id], onDelete: Cascade)

  // Метаданные изменений (JSON)
  metadata    Json?

  createdAt   DateTime     @default(now())

  @@index([userId])
  @@index([projectId])
  @@index([taskId])
  @@index([createdAt])
  @@map("activities")
}

enum FileType {
  AVATAR      // Аватар пользователя
  DOCUMENT    // Документ
  IMAGE       // Изображение
  ARCHIVE     // Архив
  OTHER       // Другое
}

model File {
  id          String   @id @default(uuid())
  name        String   // Оригинальное имя файла
  type        FileType
  mimeType    String   // MIME тип
  size        Int      // Размер в байтах
  url         String   // URL в S3
  key         String   // Ключ в S3

  // Владелец файла
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Связанные объекты (опционально)
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)

  taskId      String?
  task        Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([projectId])
  @@index([taskId])
  @@index([type])
  @@map("files")
}

model UserSettings {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Настройки уведомлений
  emailNotifications    Boolean @default(true)
  taskNotifications     Boolean @default(true)
  projectNotifications  Boolean @default(true)
  deadlineNotifications Boolean @default(true)

  // Настройки интерфейса
  theme                 String  @default("dark") // dark, light
  language              String  @default("ru")   // ru, en

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_settings")
}
